<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>약국 매물 리스트</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-50 p-6 min-h-screen">
  <div class="max-w-screen-xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">약국 매물 리스트</h1>

    <!-- 검색 입력창과 로그아웃 버튼 -->
    <div class="flex justify-between items-center mb-4">
      <input id="search" type="text" placeholder="검색어 입력..." class="border px-4 py-2 rounded w-full max-w-md" />
      <button onclick="logout()" class="ml-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">로그아웃</button>
    </div>

    <!-- 데이터 테이블 영역 -->
    <div class="overflow-auto">
      <table class="min-w-full text-sm text-left border" id="data-table"></table>
    </div>

    <!-- 에러 메시지 출력 -->
    <p id="error-message" class="text-red-500 mt-4"></p>
  </div>

  <script>
    // Supabase 연결 정보 설정
    const supabase = supabase.createClient(
      'https://seesxktrbazpfdhrxoaf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlZXN4a3RyYmF6cGZkaHJ4b2FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4MDY5NzYsImV4cCI6MjA1ODM4Mjk3Nn0.yyWASLW_h5UrdzGJha5exEtGx4iK6xAqXNSXIbR73QY'
    );

    // 전체 데이터와 현재 정렬 상태 저장
    let rawData = [];
    let currentSort = { key: '', asc: true };

    // 로그아웃 함수
    async function logout() {
      await supabase.auth.signOut();
      location.href = '/main.html';
    }

    // 테이블 렌더링 함수
    function renderTable(data) {
      const table = document.getElementById('data-table');
      if (!data.length) {
        table.innerHTML = '<tr><td class="p-4">데이터가 없습니다</td></tr>';
        return;
      }

      // 테이블 헤더 (정렬 가능한 열)
      let html = '<thead class="bg-gray-200 text-xs text-gray-700 uppercase">';
      html += '<tr>' + Object.keys(data[0])
        .map(key => `<th class="cursor-pointer p-2 border" onclick="sortTable('${key}')">${key}</th>`)
        .join('') + '</tr></thead>';

      // 테이블 본문
      html += '<tbody>';
      html += data.map(row =>
        '<tr class="border-t">' +
        Object.values(row).map(value => `<td class="p-2 border">${value ?? ''}</td>`).join('') +
        '</tr>'
      ).join('');
      html += '</tbody>';

      table.innerHTML = html;
    }

    // 검색 필터링 함수
    function filterData(keyword) {
      const lower = keyword.toLowerCase();
      const filtered = rawData.filter(row =>
        Object.values(row).some(value =>
          String(value).toLowerCase().includes(lower)
        )
      );
      renderTable(filtered);
    }

    // 정렬 함수
    function sortTable(key) {
      const sorted = [...rawData].sort((a, b) => {
        if (a[key] < b[key]) return currentSort.asc ? -1 : 1;
        if (a[key] > b[key]) return currentSort.asc ? 1 : -1;
        return 0;
      });
      currentSort = { key, asc: !currentSort.asc };
      renderTable(sorted);
    }

    // 페이지 로드 시 실행되는 데이터 로딩 함수
    async function loadData() {
      // 로그인 확인
      const { data: sessionData } = await supabase.auth.getUser();
      const user = sessionData.user;
      if (!user) {
        location.href = '/main.html';
        return;
      }

      // 승인된 사용자 여부 확인
      const { data: approvals } = await supabase
        .from('approved_users')
        .select('*')
        .eq('email', user.email)
        .eq('approved', true);

      if (!approvals || approvals.length === 0) {
        document.getElementById('error-message').textContent = '승인되지 않은 사용자입니다. 로그아웃합니다.';
        setTimeout(logout, 2000);
        return;
      }

      // 데이터 불러오기
      const { data, error } = await supabase.from('pharm_crawling_results').select('*');
      if (error) {
        document.getElementById('error-message').textContent = '데이터 불러오기 실패: ' + error.message;
        return;
      }

      rawData = data;
      renderTable(data);
    }

    // 검색창 이벤트 연결
    document.getElementById('search').addEventListener('input', e => filterData(e.target.value));

    // 초기 데이터 로드 실행
    loadData();
  </script>
</body>
</html>
